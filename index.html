
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echo Drift - Stage 4</title>
<style>
  body { margin: 0; background: black; color: white; font-family: sans-serif; overflow: hidden; }
  canvas { display: block; background: black; }
  #ui { position: absolute; top: 10px; left: 10px; z-index: 10; color: white; }
  #tapToStart, #crashOverlay {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: white; font-size: 24px;
    background: rgba(0, 0, 0, 0.8); padding: 20px; border: 2px solid white;
    display: none; z-index: 20;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="400"></canvas>
<div id="ui">
  <div id="lapLabel">Lap 1 / 5</div>
</div>
<div id="tapToStart">Tap to Start</div>
<div id="crashOverlay">Crashed into your Echo!<br><br>Tap to Restart</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const tapToStart = document.getElementById("tapToStart");
const crashOverlay = document.getElementById("crashOverlay");
const lapLabel = document.getElementById("lapLabel");

let started = false;
let crashed = false;
let tilt = 0;
let targetTilt = 0;

let car = { x: 200, y: 100, angle: -Math.PI/2, lap: 1, path: [] };
let ghosts = [];
let crossed = false;
let lapCooldown = 0;

function drawTrack() {
  ctx.strokeStyle = "#4444ff";
  ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.arc(200, 200, 100, 0, 2 * Math.PI);
  ctx.stroke();

  // Draw lap line
  ctx.strokeStyle = "#ff0000";
  ctx.beginPath();
  ctx.moveTo(200, 100);
  ctx.lineTo(200, 95);
  ctx.stroke();
}

function drawCar(x, y, angle, color = "lime") {
  const size = 10;
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(angle);
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(0, -size);
  ctx.lineTo(size, size);
  ctx.lineTo(-size, size);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function updateCar() {
  tilt += (targetTilt - tilt) * 0.1;
  car.angle += tilt * 0.002;

  const radius = 100;
  car.x = 200 + Math.cos(car.angle) * radius;
  car.y = 200 + Math.sin(car.angle) * radius;

  // Store path data
  car.path.push({ angle: car.angle });

  // Lap detection
  const angleDeg = (car.angle * 180 / Math.PI + 360) % 360;
  if (angleDeg > 350 || angleDeg < 10) {
    if (!crossed && lapCooldown === 0) {
      crossed = true;
      lapCooldown = 60; // cooldown to prevent multiple triggers
      if (car.lap < 5) {
        ghosts.push({ path: [...car.path], index: 0 });
        car.path = [];
        car.lap++;
        lapLabel.textContent = "Lap " + car.lap + " / 5";
      }
    }
  } else {
    crossed = false;
  }

  if (lapCooldown > 0) lapCooldown--;
}

function updateGhosts() {
  for (let ghost of ghosts) {
    if (ghost.index < ghost.path.length) {
      const angle = ghost.path[ghost.index].angle;
      ghost.x = 200 + Math.cos(angle) * 100;
      ghost.y = 200 + Math.sin(angle) * 100;
      ghost.angle = angle;
      ghost.index++;
    }
    drawCar(ghost.x, ghost.y, ghost.angle, "cyan");

    // Collision
    const dx = ghost.x - car.x;
    const dy = ghost.y - car.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < 15 && !crashed) {
      crashed = true;
      crashOverlay.style.display = "block";
      started = false;
    }
  }
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawTrack();
  if (started && !crashed) {
    updateCar();
    updateGhosts();
    drawCar(car.x, car.y, car.angle);
  } else if (!started && !crashed) {
    drawCar(car.x, car.y, car.angle);
  } else if (crashed) {
    drawGhostsOnly();
  }
  requestAnimationFrame(gameLoop);
}

function drawGhostsOnly() {
  for (let ghost of ghosts) {
    if (ghost.index < ghost.path.length) {
      const angle = ghost.path[ghost.index].angle;
      ghost.x = 200 + Math.cos(angle) * 100;
      ghost.y = 200 + Math.sin(angle) * 100;
      ghost.angle = angle;
    }
    drawCar(ghost.x, ghost.y, ghost.angle, "cyan");
  }
}

tapToStart.addEventListener("click", () => {
  started = true;
  tapToStart.style.display = "none";
});

crashOverlay.addEventListener("click", () => {
  location.reload();
});

window.addEventListener("deviceorientation", function(event) {
  if (event.gamma !== null) {
    targetTilt = event.gamma;
  }
}, true);

tapToStart.style.display = "block";
gameLoop();
</script>
</body>
</html>
