
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Echo Drift - Rotation Controls</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      font-family: 'Orbitron', sans-serif;
    }
    canvas {
      display: block;
      background: radial-gradient(circle at center, #111 0%, #000 100%);
    }
    #ui {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      color: #0ff; text-align: center; z-index: 10;
    }
    .mobile-controls {
      position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10;
    }
    .mobile-controls button {
      width: 60px; height: 60px; margin: 10px; font-size: 24px;
      background: #111; color: #0ff; border: 2px solid #0ff; border-radius: 50%;
      transition: transform 0.1s, background 0.2s;
    }
    .mobile-controls button:active {
      background: #0ff; color: #000;
      transform: scale(1.2);
    }
    #toggleTilt {
      position: absolute; top: 10px; right: 10px; z-index: 11;
      background: #111; color: #0ff; border: 2px solid #0ff; padding: 6px 12px;
      border-radius: 10px; font-size: 14px;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
</head>
<body>
  <div id="ui">
    <h1>Echo Drift</h1>
    <button onclick="startCountdown()">Start Game</button>
    <p id="lapInfo">Lap: 1/5</p>
    <p id="countdown"></p>
    <button onclick="toggleMusic()">Toggle Music</button>
  </div>
  <button id="toggleTilt" onclick="toggleTilt()">Tilt: Off</button>
  <div class="mobile-controls">
    <button ontouchstart="keys['ArrowLeft']=true" ontouchend="keys['ArrowLeft']=false">←</button>
    <button ontouchstart="keys['ArrowUp']=true" ontouchend="keys['ArrowUp']=false">↑</button>
    <button ontouchstart="keys['ArrowRight']=true" ontouchend="keys['ArrowRight']=false">→</button>
  </div>
  <canvas id="gameCanvas"></canvas>
  <audio id="bgMusic" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
  </audio>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let running = false, lap = 1, ghosts = [], ghostPaths = [], playerPath = [], countdown = 3;
    let tiltEnabled = false, tiltAngle = 0;
    let frame = 0;
    let keys = {};
    let music = document.getElementById('bgMusic');

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let centerX = () => canvas.width / 2;
    let centerY = () => canvas.height / 2;
    let trackRadius = () => Math.min(canvas.width, canvas.height) / 3;

    let player = {
      x: centerX() + trackRadius() * Math.cos(-Math.PI / 2),
      y: centerY() + trackRadius() * Math.sin(-Math.PI / 2),
      angle: 0,
      speed: 0,
      maxSpeed: 3,
      radius: 10,
      color: '#0ff',
      shield: false,
      shieldTimer: 0
    };

    function spawnShield() {
      let angle = Math.random() * 2 * Math.PI;
      let r = trackRadius();
      return {
        x: centerX() + r * Math.cos(angle),
        y: centerY() + r * Math.sin(angle),
        active: true,
        timer: 600
      };
    }

    let shieldPowerup = spawnShield();

    function startCountdown() {
      document.getElementById('countdown').innerText = countdown;
      const interval = setInterval(() => {
        countdown--;
        document.getElementById('countdown').innerText = countdown > 0 ? countdown : 'GO!';
        if (countdown < 0) {
          clearInterval(interval);
          document.getElementById('ui').style.display = 'none';
          running = true;
          requestAnimationFrame(gameLoop);
        }
      }, 1000);
    }

    function toggleMusic() {
      if (music.paused) music.play();
      else music.pause();
    }

    function toggleTilt() {
      tiltEnabled = !tiltEnabled;
      document.getElementById("toggleTilt").innerText = "Tilt: " + (tiltEnabled ? "On" : "Off");
      if (tiltEnabled) {
        window.addEventListener("deviceorientation", handleTilt, true);
      } else {
        window.removeEventListener("deviceorientation", handleTilt, true);
      }
    }

    function handleTilt(event) {
      if (!event.gamma) return;
      tiltAngle = event.gamma;
    }

    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => keys[e.key] = false);

    function updatePlayer() {
      if (tiltEnabled) {
        player.angle += tiltAngle / 100;
      } else {
        if (keys['ArrowLeft']) player.angle -= 0.05;
        if (keys['ArrowRight']) player.angle += 0.05;
      }

      if (keys['ArrowUp']) {
        player.speed = Math.min(player.speed + 0.1, player.maxSpeed);
      } else {
        player.speed *= 0.98;
      }

      player.x += Math.cos(player.angle) * player.speed;
      player.y += Math.sin(player.angle) * player.speed;
      playerPath.push({x: player.x, y: player.y});

      if (player.shieldTimer > 0) {
        player.shield = true;
        player.shieldTimer--;
      } else {
        player.shield = false;
      }

      if (shieldPowerup.active &&
          Math.hypot(player.x - shieldPowerup.x, player.y - shieldPowerup.y) < player.radius + 10) {
        player.shield = true;
        player.shieldTimer = 300;
        shieldPowerup.active = false;
      }

      if (shieldPowerup.timer-- < 0 && !shieldPowerup.active) {
        shieldPowerup = spawnShield();
      }
    }

    function drawTrack() {
      ctx.strokeStyle = '#3030ff';
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.arc(centerX(), centerY(), trackRadius(), 0, Math.PI * 2);
      ctx.stroke();

      ctx.strokeStyle = '#ff0';
      ctx.beginPath();
      ctx.moveTo(centerX() + trackRadius(), centerY() - 20);
      ctx.lineTo(centerX() + trackRadius(), centerY() + 20);
      ctx.stroke();
    }

    function drawPlayer(p, ghost = false) {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle || 0);
      ctx.fillStyle = ghost ? 'rgba(255,0,255,0.3)' : (player.shield ? '#00ffff' : player.color);
      ctx.shadowBlur = ghost ? 0 : 15;
      ctx.shadowColor = player.shield ? '#00ffff' : player.color;
      ctx.beginPath();
      ctx.moveTo(0, -10);
      ctx.lineTo(6, 10);
      ctx.lineTo(-6, 10);
      ctx.closePath();
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.restore();
    }

    function drawGhosts() {
      for (let g of ghosts) {
        if (g[frame]) drawPlayer(g[frame], true);
      }
    }

    function drawShieldPowerup() {
      if (shieldPowerup.active) {
        ctx.beginPath();
        ctx.arc(shieldPowerup.x, shieldPowerup.y, 10, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,255,255,0.6)';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#0ff';
        ctx.fill();
        ctx.shadowBlur = 0;
      }
    }

    function checkCollision() {
      for (let g of ghosts) {
        const point = g[frame];
        if (point && Math.hypot(player.x - point.x, player.y - point.y) < player.radius * 2) {
          if (!player.shield) {
            running = false;
            alert("Crashed into your echo! Game Over.");
          } else {
            player.shield = false;
            player.shieldTimer = 0;
          }
        }
      }
    }

    function completeLap() {
      if (
        player.x > centerX() + trackRadius() - 10 &&
        player.x < centerX() + trackRadius() + 10 &&
        player.y > centerY() - 20 &&
        player.y < centerY() + 20
      ) {
        ghosts.push([...playerPath]);
        playerPath = [];
        lap++;
        shieldPowerup = spawnShield();
        if (lap > 5) {
          running = false;
          alert("Victory! You survived all 5 laps.");
        }
        document.getElementById('lapInfo').innerText = `Lap: ${lap}/5`;
      }
    }

    function gameLoop() {
      if (!running) return;
      frame++;
      updatePlayer();
      checkCollision();
      completeLap();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawTrack();
      drawShieldPowerup();
      drawGhosts();
      drawPlayer(player);
      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
